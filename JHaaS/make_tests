SHELL=/usr/bin/bash
DATA=$$HOME/teaching_MS-MO-ABS/data/

test_unix: test_ex_unix_basic1 test_ex_unix_basic2 test_ex_unix_basic3 test_ex_unix_basic4 test_ex_unix_level2 test_ex_unix_fileformats test_lecture_unix
test_tour: test_lecture_tour
test_ngs: test_ngs_mapping test_ngs_bowtie2

test_ngs_bowtie2: test_ngs_sra
	@bowtie2 -x ~/biodata/hg19 -1 SRR3923550_1.fastq.bz2 -2 SRR3923550_2.fastq.bz2 -S SRR3923550_full.sam -p 4
	@samtools view -bh SRR3923550_full.sam -o SRR3923550_full.bam
	@samtools sort SRR3923550_full.bam -o SRR3923550_full_sorted.bam
	@samtools index SRR3923550_full_sorted.bam
	@samtools mpileup -r chr9:21971132-21971142 SRR3923550_full_sorted.bam
	
test_ngs_mapping:
	@mkdir ~/04_NGS/hg19_chr9_index -p
	@cd ~/04_NGS/hg19_chr9_index
	@wget http://hgdownload.soe.ucsc.edu/goldenPath/hg19/chromosomes/chr9.fa.gz
	@gunzip chr9.fa.gz
	@bowtie2-build --threads 4 chr9.fa hg19_chr9

test_ngs_sra:
	#SRR3923550
	@mkdir ~/04_NGS
	@cd ~/04_NGS
	@fasterq-dump -p SRR3923550  # ~1GB of data
	@bzip2 --fast SRR*.fastq

test_lecture_tour:
	# Bioinformatics Tour (must be executed in the appropriate conda env)
	@mafft
	@mafft meiers.fasta
	@hmmbuild meiers.hmm meiers.msa
	@hmmsearch meiers.hmm meierhistory.txt
	@fasttree meiers.msa
	@mafft <(for l in `cat meiers.fasta | grep -v "^>"`; do echo ">$$l"; echo $$l; done) 2> /dev/null | fasttree
	@cdhit -i meiers.fasta -o cluster_meiers -l 4 -c 0.6 -n 3
	@split -l 2 meiers.fasta sm_ && mash dist sm_* -k 1
	@mash dist NC_*.gz -k 15 | cut -f 2- | column -t
	@zcat NC_000913* | prodigal -a ecoli.fasta
	@zcat NC_003210* | prodigal -a listeria.fasta
	@diamond makedb -d ecoli --in ecoli.fasta
	@diamond blastp --db ecoli -q listeria.fasta | cut -f 1 | sort | uniq -c | sort -n | tail -n 20
	@diamond blastp --max-target-seqs 1 --db ecoli -q listeria.fasta | cut -f 1 | sort | uniq -c | sort -n | tail -n 20
	@spades.py -s ass_reads_50-30.fq.gz -o myassembly
	@spades.py -s ass_reads_50-60.fq.gz -o myassembly_60
	@mafft <(cat sarscov2_* myassembly_60/contigs.fasta) 2> /dev/null
	@cat trna.fasta | RNAfold
	@cat mrna.fasta hsa-mir* | RNAfold
	@wget "https://rfam.org/family/RF00675/alignment?acc=RF00675&format=stockholm&download=0" -O mir145.stk
	@cmbuild mir145.cm mir145.stk
	@cmalign mir145.cm hg38_chr5_rnahit.fasta

test_ex_unix_basic1:
	@echo "hello world"
	@date
	@whoami
	@which -a top
	@echo {con,pre}{sent,fer}{s,ed}
	@which -a man
	@which -a bc
	@echo 5+4 | bc -l
	@time sleep 1
	#history  # a bash feature, not a command

test_ex_unix_basic2:
	@pwd
	@which -a ls
	@mkdir 'Exercise 1'
	@mv 'Exercise 1' Exercise_1
	@which -a rmdir
	@which -a mv

test_ex_unix_basic3:
	@touch catcontent.txt
	@cat catcontent.txt
	@touch .invisible_kitten
	@echo "inhalt" > .invisible_kitten
	@which -a more
	@which -a cp

test_ex_unix_basic4:
	@which -a readlink
	@which -a head
	@which -a tail
	@which -a nano
	@which -a rm
	@which -a groups

test_ex_unix_level2:
	# exercise: Linux Level 2, 1-4
	@mkdir -p www www/html www/java temp junk
	@touch junk/useless
	@cp junk/useless temp/
	@mv temp/useless ~/ && mv junk/useless ~/othername
	@rm useless othername
	
	# exercise: Linux Level 2, 5
	@cd junk && touch useless && chmod g+rw useless && chmod u+rwx useless && chmod o-rwx useless
	@chgrp biologists junk/useless
	
	# exercise: Linux Level 2, 6
	@touch junk/shared.txt && chgrp biologists junk/shared.txt
	
	# exercise: Linux Level 2, 7
	@rm -rf www www/html www/java temp junk
	
	# exercise: Linux Level 2, 8
	@touch -- '-r' && rm -- '-r'
	
	# exercise: Linux Level 2, 9
	@head -n 3 ${DATA}/Unix/students.txt
	@tail -n 12 ${DATA}/Unix/students.txt
	
test_ex_unix_fileformats:
	# exercise: Linux - Bioinformatics file Formats
	@ls -lah ${DATA}/Unix/hg19*
	@wc ${DATA}/Unix/hg19*
	@grep "^>" -c ${DATA}/Unix/hg19*.faa
	@grep `grep "RPS8" ${DATA}/Unix/hg19_chr1_RefSeq_mapping.txt | cut -f 1` ${DATA}/Unix/hg19_chr1_RefSeq_genes.gtf  | grep exon -c

	@tail -n +2 ${DATA}/Unix/hg19_chr1_RefSeq_mapping.txt | cut -f 2 | sort -u | wc -l
	@tail -n +2 ${DATA}/Unix/hg19_chr1_RefSeq_mapping.txt | sort -k2,2 | awk '{print $2}' | uniq | wc -l
	@tail -n +2 ${DATA}/Unix/hg19_chr1_RefSeq_mapping.txt | awk '{print $2}' | sort | uniq | wc -l

	@sed -n '/NM_001012.1/,/>/p' ${DATA}/Unix/hg19_chr1_RefSeq_genes.faa | head -n -1
	@awk 'BEGIN{RS=">";FS="\n"}NR>1 {if ($$1~/NM_001012.1/)print ">"$$0}' ${DATA}/Unix/hg19_chr1_RefSeq_genes.faa

	@which -a sort
	@which -a uniq
	@which -a grep

test_lecture_unix:
	# lecture "Unix Basics"
	@touch testFile.txt
	@export PS1="\u@\h:\w :-)  "
	@mv testFile.txt foo.txt
	@cp foo.txt barcopy.txt
	@rm foo.txt
	@touch baz.txt
	@cp barcopy.txt .hidden.txt
	@rm .hidden.txt barcopy.txt baz.txt
	@mkdir -p tuser/Mail tuser/thesis/{pictures,literature}
	@touch tuser/baz.txt tuser/Mail/hello.txt tuser/thesis/literature/{1,2,3}.pdf tuser/thesis/Abstract.txt
	@ps -u ${NB_USER}
	
	@cat ${DATA}/Unix/users.txt
	@head -2 ${DATA}/Unix/users.txt
	@tail -1 ${DATA}/Unix/users.txt
	@echo "Hello World"
	@sort ${DATA}/Unix/users.txt
	@wc -l ${DATA}/Unix/users.txt
	@grep User ${DATA}/Unix/users.txt
	@cat ${DATA}/Unix/awk.txt | cut -f 1 | cut -b 6-
	@ps -ef > ps.txt && head -3 ps.txt
	@sort < ${DATA}/Unix/users.txt
	@cat ${DATA}/Unix/users.txt | sort
	@ps -f -u `whoami`
	@find ${NB_HOME} -name users.txt
	@basename /homes/juser/foo.jpg 
	@dirname /homes/juser/foo.jpg 
	@touch ~/foo.jpg && readlink -f ~/foo.jpg
	
	@wget http://hgdownload.soe.ucsc.edu/goldenPath/hg38/chromosomes/chr21.fa.gz
	@gunzip chr21.fa.gz
	@tail -n 2000 chr21.fa | head -n 15 > chr21subset.fa; true  # see https://stackoverflow.com/questions/19120263/why-exit-code-141-with-grep-q
	@cat chr21subset.fa | grep "atg"
	@cat chr21subset.fa | sed s/atg/ATG/g
	@cat chr21subset.fa | tr -d "\n" | sed s/atg/ATG/g | fold -w 50
